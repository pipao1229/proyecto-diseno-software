{% extends 'dashboard/_base.html' %}

{% block content %}
<style>
    /* Estilos del Tema Oscuro */
    .kpi-card { background-color: #343a40; border-radius: 8px; padding: 1.25rem; color: #f8f9fa; text-align: center; }
    .kpi-card-title { font-size: 0.9rem; color: #adb5bd; margin-bottom: 0.5rem; }
    .kpi-card-value { font-size: 2rem; font-weight: bold; }
    .chart-container { background-color: #343a40; padding: 1rem; border-radius: 8px; position: relative; height: 350px; }
    .active-filters-bar { background-color: #343a40; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #495057; font-size: 0.9rem; }
</style>

<!-- Barra de Filtros Activos -->
<div id="active-filters-bar" style="display: none;">
    <i class="fas fa-filter"></i> <strong>Filtros activos:</strong>
    <span id="active-filters-text"></span>
</div>

<!-- Contenedores para KPIs y Gráficos -->
<div class="row g-4 mb-4" id="kpi-cards-container"><p class="text-center">Cargando KPIs...</p></div>
<div class="row g-4">
    <div class="col-lg-8"><div class="chart-container"><canvas id="conversionPorEdadChart"></canvas></div></div>
    <div class="col-lg-4"><div class="chart-container"><canvas id="distribucionResultadosChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="tendenciaMensualChart"></canvas></div></div>
    <div class="col-md-6"><div class="chart-container"><canvas id="exitoPorCanalChart"></canvas></div></div>
    <div class="col-md-6"><div class="chart-container"><canvas id="contactosPreviosChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionDemoraChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionHipotecaChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionPrestamoChart"></canvas></div></div>
    <div class="col-md-8"><div class="chart-container"><canvas id="distribucionEdadesChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionEstadoCivilChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionBalanceChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionDuracionChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionDiaMesChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="diasUltimoContactoChart"></canvas></div></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartInstances = {};

    function displayActiveFiltersFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeFilterParts = [];
        const tempFilters = {};

        urlParams.forEach((value, key) => {
            if (key !== 'page' && key !== 'sort_by') {
                if (!tempFilters[key]) tempFilters[key] = [];
                tempFilters[key].push(value);
            }
        });

        if (tempFilters.age_min || tempFilters.age_max) {
             activeFilterParts.push(`Edad: ${tempFilters.age_min || '?'} - ${tempFilters.age_max || '?'}`);
             delete tempFilters.age_min;
             delete tempFilters.age_max;
        }

        for (const [key, values] of Object.entries(tempFilters)) {
             let label = key.charAt(0).toUpperCase() + key.slice(1);
             activeFilterParts.push(`${label}: ${values.join(', ')}`);
        }
        
        const filterText = activeFilterParts.join(' | ');
        if (filterText) {
            document.getElementById('active-filters-text').textContent = filterText;
            document.getElementById('active-filters-bar').style.display = 'block';
        } else {
            document.getElementById('active-filters-text').textContent = " Sin filtros aplicados";
            document.getElementById('active-filters-bar').style.display = 'block';
        }
    }
    
    async function fetchData() {
        const queryString = window.location.search.substring(1);
        try {
            const response = await fetch(`/analytics/api/kpi-data/?${queryString}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error("Error fetching analytics data:", error);
            document.getElementById('kpi-cards-container').innerHTML = `<p class="text-center text-danger">Error al cargar los datos.</p>`;
        }
    }
    
    function renderKpiCards(kpis) {
        const container = document.getElementById('kpi-cards-container');
        const kpiMap = {
            tasa_conversion: { title: 'Tasa de Conversión', suffix: '%' },
            total_contactos: { title: 'Total de Contactos', suffix: '', decimals: 0 },
            duracion_promedio: { title: 'Duración Promedio', suffix: 's', decimals: 0 },
            rentabilidad_proyectada: { title: 'Rentabilidad Proyectada', suffix: '€', decimals: 0 },
            clientes_aceptaron: { title: 'Clientes que Aceptaron', suffix: '', decimals: 0 },
            historiales_exitosos: { title: 'Historiales Exitosos', suffix: '', decimals: 0 },
            impacto_historial: { title: 'Impacto Historial', suffix: '%' },
            indice_eficiencia: { title: 'Índice Eficiencia', suffix: '', decimals: 2 },
            ganancia_por_llamada: { title: 'Ganancia por Llamada', suffix: '€', decimals: 2 },
        };
        let html = '';
        for (const [key, config] of Object.entries(kpiMap)) {
            const value = kpis[key] || 0;
            const decimals = 'decimals' in config ? config.decimals : 1;
            const finalValue = parseFloat(value).toFixed(decimals);
            html += `<div class="col-md-4 col-lg-3"><div class="kpi-card"><div class="kpi-card-title">${config.title}</div><div class="kpi-card-value">${finalValue}${config.suffix}</div></div></div>`;
        }
        container.innerHTML = html;
    }

    function renderChart(chartId, type, data, specificOptions = {}, isPercentage = false) {
        const ctx = document.getElementById(chartId)?.getContext('2d');
        if (!ctx) return;
        
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
        }

        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: '#adb5bd' } },
                tooltip: { callbacks: {} }
            },
            scales: {
                x: { ticks: { color: '#adb5bd' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                y: { ticks: { color: '#adb5bd' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
        };
        
        if (isPercentage) {
            defaultOptions.plugins.tooltip.callbacks.label = context => `${context.dataset.label || ''}: ${context.parsed.y.toFixed(2)}%`;
            defaultOptions.scales.y.ticks.callback = value => `${value}%`;
        }

        // Función auxiliar para unir opciones de gráficos de forma anidada
        function deepMerge(target, source) {
            const output = { ...target };
            if (isObject(target) && isObject(source)) {
                Object.keys(source).forEach(key => {
                    if (isObject(source[key])) {
                        if (!(key in target)) Object.assign(output, { [key]: source[key] });
                        else output[key] = deepMerge(target[key], source[key]);
                    } else {
                        Object.assign(output, { [key]: source[key] });
                    }
                });
            }
            return output;
        }

        function isObject(item) {
            return (item && typeof item === 'object' && !Array.isArray(item));
        }

        const finalOptions = deepMerge(defaultOptions, specificOptions);

        chartInstances[chartId] = new Chart(ctx, { type, data, options: finalOptions });
    }

    function updateDashboard(data) {
        if (!data) return;
        renderKpiCards(data.kpi_cards);

        const titleColor = '#f8f9fa';

        // Gráficos de Porcentaje
        renderChart('conversionPorEdadChart', 'bar', { labels: data.charts.conversion_por_edad.labels, datasets: [{ label: 'Tasa de Conversión', data: data.charts.conversion_por_edad.data, backgroundColor: '#0d6efd' }] }, {plugins: {title: { display: true, text: 'Conversión por Segmento de Edad', color: titleColor }}}, true);
        renderChart('tendenciaMensualChart', 'line', { labels: data.charts.tendencia_mensual.labels, datasets: [{ label: 'Tasa de Conversión', data: data.charts.tendencia_mensual.data, borderColor: '#0dcaf0', tension: 0.1 }] }, {plugins: {title: { display: true, text: 'Tendencia Mensual de Conversión', color: titleColor }}}, true);
        renderChart('exitoPorCanalChart', 'bar', { labels: data.charts.exito_por_canal.labels, datasets: [{ label: 'Tasa de Conversión', data: data.charts.exito_por_canal.data, backgroundColor: ['#ffc107', '#fd7e14'] }] }, {plugins: {title: { display: true, text: 'Éxito por Canal de Contacto', color: titleColor }}}, true);
        renderChart('contactosPreviosChart', 'bar', { labels: data.charts.contactos_previos_conversion.labels, datasets: [{ label: 'Tasa de Conversión', data: data.charts.contactos_previos_conversion.data, backgroundColor: '#6f42c1' }] }, { plugins: {title: { display: true, text: 'Contactos Previos vs Conversión', color: titleColor }}, scales: { x: { title: { display: true, text: 'Nº Contactos Previos', color: '#adb5bd' } } } }, true);
        renderChart('distribucionDiaMesChart', 'line', { labels: data.charts.distribucion_dia_mes.labels, datasets: [{ label: 'Tasa de Conversión', data: data.charts.distribucion_dia_mes.data, borderColor: '#198754' }] }, {plugins: {title: { display: true, text: 'Distribución de Tasa de Conv. por Día del Mes', color: titleColor }}}, true);
        
        // Gráficos de Conteo (isPercentage = false por defecto)
        renderChart('distribucionResultadosChart', 'doughnut', { labels: data.charts.distribucion_resultados.labels, datasets: [{ data: data.charts.distribucion_resultados.data, backgroundColor: ['#dc3545', '#198754'] }] }, {plugins: {title: { display: true, text: 'Distribución de Resultados', color: titleColor }}});
        renderChart('distribucionDemoraChart', 'bar', { labels: data.charts.distribucion_demora.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_demora.data, backgroundColor: ['#198754', '#dc3545'] }] }, {plugins: {title: { display: true, text: 'Crédito en Demora', color: titleColor }}});
        renderChart('distribucionHipotecaChart', 'bar', { labels: data.charts.distribucion_hipoteca.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_hipoteca.data, backgroundColor: ['#198754', '#dc3545'] }] }, {plugins: {title: { display: true, text: 'Préstamo Hipotecario', color: titleColor }}});
        renderChart('distribucionPrestamoChart', 'bar', { labels: data.charts.distribucion_prestamo.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_prestamo.data, backgroundColor: ['#198754', '#dc3545'] }] }, {plugins: {title: { display: true, text: 'Préstamo Personal', color: titleColor }}});
        renderChart('distribucionEdadesChart', 'bar', { labels: data.charts.distribucion_edades.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_edades.data, backgroundColor: '#0d6efd' }] }, {plugins: {title: { display: true, text: 'Distribución de Edades', color: titleColor }}});
        renderChart('distribucionEstadoCivilChart', 'doughnut', { labels: data.charts.distribucion_estado_civil.labels, datasets: [{ data: data.charts.distribucion_estado_civil.data, backgroundColor: ['#0dcaf0', '#0d6efd', '#6f42c1', '#d63384'] }] }, {plugins: {title: { display: true, text: 'Estado Civil', color: titleColor }}});
        renderChart('distribucionBalanceChart', 'bar', { labels: data.charts.distribucion_balance.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_balance.data, backgroundColor: '#fd7e14' }] }, {plugins: {title: { display: true, text: 'Distribución de Balance', color: titleColor }}});
        renderChart('distribucionDuracionChart', 'line', { labels: data.charts.distribucion_duracion.labels, datasets: [{ label: 'Clientes', data: data.charts.distribucion_duracion.data, fill: true, backgroundColor: 'rgba(13, 110, 253, 0.2)', borderColor: '#0d6efd' }] }, {plugins: {title: { display: true, text: 'Distribución de Duración de Llamadas', color: titleColor }}});
        renderChart('diasUltimoContactoChart', 'bar', { labels: data.charts.dias_ultimo_contacto.labels, datasets: [{ label: 'Clientes', data: data.charts.dias_ultimo_contacto.data, backgroundColor: '#ffc107' }] }, {plugins: {title: { display: true, text: 'Análisis de Días desde Último Contacto', color: titleColor }}});
    }

    // Carga inicial
    displayActiveFiltersFromURL();
    fetchData();
});
</script>
{% endblock scripts %}