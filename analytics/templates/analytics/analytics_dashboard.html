{% extends 'dashboard/_base.html' %}

{% block content %}
<style>
    .kpi-card {
        background-color: #343a40;
        border-radius: 8px;
        padding: 1.25rem;
        color: #f8f9fa;
    }
    .kpi-card-title {
        font-size: 0.9rem;
        color: #adb5bd;
        margin-bottom: 0.5rem;
    }
    .kpi-card-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .chart-container {
        background-color: #343a40;
        padding: 1rem;
        border-radius: 8px;
        position: relative; /* Necesario para que el responsive de Chart.js funcione bien */
        height: 350px;
    }
    /* Estilos de píldoras del otro tab */
    .filter-pills .btn { margin: 2px; background-color: #495057; color: #f8f9fa; border: 1px solid #6c757d; font-size: 0.8rem; }
    .filter-pills .btn.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
    .filter-section h6 { margin-top: 1rem; color: #adb5bd; }
</style>

<!-- FILTROS -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between">
        <h5><i class="fas fa-filter"></i> Filtros Dinámicos</h5>
        <div>
            <button id="clear-filters-btn" class="btn btn-secondary btn-sm">Limpiar Filtros</button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Rango de edad -->
            <div class="col-md-12 mb-3">
                <label for="age_min" class="form-label">Edad:</label>
                <div class="d-flex">
                    <input type="number" id="age_min" class="form-control form-control-sm me-2" placeholder="Min">
                    <input type="number" id="age_max" class="form-control form-control-sm" placeholder="Max">
                </div>
            </div>
            <!-- Filtros Categóricos -->
            {% for field in form %}{% if field.name not in "age_min,age_max,sort_by" %}<div class="col-md-4 filter-section"><h6>{{ field.label }}</h6><div class="filter-pills" id="pills-{{ field.name }}">{% for value, text in field.field.choices %}<button class="btn btn-sm" data-field="{{ field.name }}" data-value="{{ value }}">{{ text }}</button>{% endfor %}</div></div>{% endif %}{% endfor %}
        </div>
    </div>
</div>

<!-- KPIs -->
<div class="row g-4 mb-4" id="kpi-cards-container">
    <!-- Las tarjetas KPI se insertarán aquí -->
</div>

<!-- Gráficos -->
<div class="row g-4">
    <div class="col-lg-8"><div class="chart-container"><canvas id="conversionPorEdadChart"></canvas></div></div>
    <div class="col-lg-4"><div class="chart-container"><canvas id="distribucionResultadosChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="tendenciaMensualChart"></canvas></div></div>
    <div class="col-md-6"><div class="chart-container"><canvas id="exitoPorCanalChart"></canvas></div></div>
    <div class="col-md-6"><div class="chart-container"><canvas id="contactosPreviosChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionDemoraChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionHipotecaChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionPrestamoChart"></canvas></div></div>
    <div class="col-md-8"><div class="chart-container"><canvas id="distribucionEdadesChart"></canvas></div></div>
    <div class="col-md-4"><div class="chart-container"><canvas id="distribucionEstadoCivilChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionBalanceChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionDuracionChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="distribucionDiaMesChart"></canvas></div></div>
    <div class="col-12"><div class="chart-container"><canvas id="diasUltimoContactoChart"></canvas></div></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentFilters = {};
    const chartInstances = {}; // Para destruir y recrear gráficos

    function buildQueryString(params) {
        const parts = [];
        for (const key in params) { const value = params[key]; if (Array.isArray(value)) { value.forEach(v => parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(v)}`)); } else if (value) { parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`); } }
        return parts.join('&');
    }
    
    function renderKpiCards(kpis) {
        const container = document.getElementById('kpi-cards-container');
        const kpiMap = {
            tasa_conversion: { title: 'Tasa de Conversión', suffix: '%' },
            total_contactos: { title: 'Total de Contactos', suffix: '' },
            duracion_promedio: { title: 'Duración Promedio', suffix: 's' },
            rentabilidad_proyectada: { title: 'Rentabilidad Proyectada', suffix: '€' },
            clientes_aceptaron: { title: 'Clientes que Aceptaron', suffix: '' },
            historiales_exitosos: { title: 'Historiales Exitosos', suffix: '' },
            impacto_historial: { title: 'Impacto Historial', suffix: '%' },
            indice_eficiencia: { title: 'Índice Eficiencia', suffix: ' /contacto', decimals: 2 },
            ganancia_por_llamada: { title: 'Ganancia por Llamada', suffix: '€', decimals: 2 },
        };
        let html = '';
        for (const [key, config] of Object.entries(kpiMap)) {
            const value = kpis[key];
            const decimals = 'decimals' in config ? config.decimals : 1;
            html += `
                <div class="col-md-4 col-lg-3">
                    <div class="kpi-card">
                        <div class="kpi-card-title">${config.title}</div>
                        <div class="kpi-card-value">${parseFloat(value).toFixed(decimals)}${config.suffix}</div>
                    </div>
                </div>`;
        }
        container.innerHTML = html;
    }

    function renderChart(chartId, type, data, specificOptions = {}) {
        const ctx = document.getElementById(chartId).getContext('2d');
        if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
        }
        
        // Opciones por defecto para TODOS los gráficos
        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#adb5bd' } // Texto de la leyenda en color claro
                }
            },
            scales: {
                x: {
                    ticks: { color: '#adb5bd' }, // Texto del eje X
                    grid: { color: 'rgba(255, 255, 255, 0.1)' } // Líneas de la cuadrícula
                },
                y: {
                    ticks: { color: '#adb5bd' }, // Texto del eje Y
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        };

        // Unimos las opciones por defecto con las específicas de cada gráfico
        const finalOptions = deepMerge(defaultOptions, specificOptions);

        chartInstances[chartId] = new Chart(ctx, { type, data, options: finalOptions });
    }

    // Función auxiliar para unir opciones de gráficos de forma anidada
    function deepMerge(target, source) {
        const output = { ...target };
        if (isObject(target) && isObject(source)) {
            Object.keys(source).forEach(key => {
                if (isObject(source[key])) {
                    if (!(key in target)) Object.assign(output, { [key]: source[key] });
                    else output[key] = deepMerge(target[key], source[key]);
                } else {
                    Object.assign(output, { [key]: source[key] });
                }
            });
        }
        return output;
    }

    function isObject(item) {
        return (item && typeof item === 'object' && !Array.isArray(item));
    }

    async function fetchData() { /* ... (igual, pero llama a /analytics/api/kpi-data/ y actualiza dashboard) ... */
        const queryString = buildQueryString(currentFilters);
        try {
            const response = await fetch(`/analytics/api/kpi-data/?${queryString}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateDashboard(data);
        } catch (error) {
            console.error("Error fetching analytics data:", error);
        }
    }

    function updateDashboard(data) {
        renderKpiCards(data.kpi_cards);

        // Llamadas para renderizar cada gráfico con los datos de la API
        renderChart('conversionPorEdadChart', 'bar', { labels: data.charts.conversion_por_edad.labels, datasets: [{ label: 'Tasa de Conversión (%)', data: data.charts.conversion_por_edad.data, backgroundColor: '#0d6efd' }] });
        renderChart('distribucionResultadosChart', 'doughnut', { labels: data.charts.distribucion_resultados.labels, datasets: [{ data: data.charts.distribucion_resultados.data, backgroundColor: ['#dc3545', '#198754'] }] });
        renderChart('tendenciaMensualChart', 'line', { labels: data.charts.tendencia_mensual.labels, datasets: [{ label: 'Tasa de Conversión (%)', data: data.charts.tendencia_mensual.data, borderColor: '#0dcaf0', tension: 0.1 }] });
        renderChart('exitoPorCanalChart', 'bar', { labels: data.charts.exito_por_canal.labels, datasets: [{ label: 'Tasa de Conversión (%)', data: data.charts.exito_por_canal.data, backgroundColor: ['#ffc107', '#fd7e14'] }] });
        renderChart('contactosPreviosChart', 'bar', { labels: data.charts.contactos_previos_conversion.labels, datasets: [{ label: 'Tasa de Conversión (%)', data: data.charts.contactos_previos_conversion.data, backgroundColor: '#6f42c1' }] }, { scales: { x: { title: { display: true, text: 'Nº Contactos Previos' } } } });
        renderChart('distribucionDemoraChart', 'bar', { labels: data.charts.distribucion_demora.labels, datasets: [{ label: 'Crédito en Demora', data: data.charts.distribucion_demora.data, backgroundColor: ['#20c997', '#dc3545'] }] });
        renderChart('distribucionHipotecaChart', 'bar', { labels: data.charts.distribucion_hipoteca.labels, datasets: [{ label: 'Préstamo Hipotecario', data: data.charts.distribucion_hipoteca.data, backgroundColor: ['#20c997', '#dc3545'] }] });
        renderChart('distribucionPrestamoChart', 'bar', { labels: data.charts.distribucion_prestamo.labels, datasets: [{ label: 'Préstamo Personal', data: data.charts.distribucion_prestamo.data, backgroundColor: ['#20c9t97', '#dc3545'] }] });
        renderChart('distribucionEdadesChart', 'bar', { labels: data.charts.distribucion_edades.labels, datasets: [{ label: 'Distribución de Edades', data: data.charts.distribucion_edades.data }] });
        renderChart('distribucionEstadoCivilChart', 'doughnut', { labels: data.charts.distribucion_estado_civil.labels, datasets: [{ data: data.charts.distribucion_estado_civil.data }] });
        renderChart('distribucionBalanceChart', 'bar', { labels: data.charts.distribucion_balance.labels, datasets: [{ label: 'Distribución de Balance', data: data.charts.distribucion_balance.data }] });
        renderChart('distribucionDuracionChart', 'line', { labels: data.charts.distribucion_duracion.labels, datasets: [{ label: 'Distribución de Duración', data: data.charts.distribucion_duracion.data, fill: true, backgroundColor: 'rgba(13, 110, 253, 0.2)' }] });
        renderChart('distribucionDiaMesChart', 'line', { labels: data.charts.distribucion_dia_mes.labels, datasets: [{ label: 'Tasa Conv. por Día del Mes', data: data.charts.distribucion_dia_mes.data }] });
        renderChart('diasUltimoContactoChart', 'bar', { labels: data.charts.dias_ultimo_contacto.labels, datasets: [{ label: 'Días desde Último Contacto', data: data.charts.dias_ultimo_contacto.data }] });
    }

    function buildQueryString(params) {const parts = []; for (const key in params) { const value = params[key]; if (Array.isArray(value)) { value.forEach(v => { parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(v)}`); }); } else if (value !== null && value !== undefined && value !== '') { parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(value)}`); } } return parts.join('&'); }
    document.querySelectorAll('.filter-pills .btn').forEach(btn => { btn.addEventListener('click', function(e) { e.preventDefault(); this.classList.toggle('active'); const field = this.dataset.field; const value = this.dataset.value; if (!currentFilters[field]) currentFilters[field] = []; const index = currentFilters[field].indexOf(value); if (index > -1) { currentFilters[field].splice(index, 1); } else { currentFilters[field].push(value); } if(currentFilters[field].length === 0) delete currentFilters[field]; fetchData(); }); });
    const ageMinInput = document.getElementById('age_min'); const ageMaxInput = document.getElementById('age_max');
    [ageMinInput, ageMaxInput].forEach(input => { input.addEventListener('input', function() { currentFilters.age_min = ageMinInput.value; currentFilters.age_max = ageMaxInput.value; fetchData(); }); });
    document.getElementById('clear-filters-btn').addEventListener('click', function() { window.location.href = "{% url 'analytics:dashboard' %}"; });

    // Carga inicial
    fetchData();
});
</script>
{% endblock scripts %}